# DeBank API Units 消耗计算文档

## 概述

本文档计算使用 DeBank Cloud API 时，100个地址每月的 units 消耗量和费用。

## 当前使用的 API 接口

我们的系统在刷新每个地址时，会调用以下 DeBank API：

| API 接口                               | 用途            | 代码位置                  |
|--------------------------------------|---------------|-----------------------|
| `/v1/user/used_chain_list`           | 获取地址使用的链列表    | `sync_service.go:169` |
| `/v1/user/all_token_list`            | 获取地址的所有代币     | `sync_service.go:207` |
| `/v1/user/all_complex_protocol_list` | 获取地址的DeFi协议持仓 | `sync_service.go:243` |

**注意**:
- `total_balance` API 在当前实现中未被使用
- 每次刷新一个地址需要调用 **3个 API 接口**

## DeBank API Units 定价（基于公开信息）

根据 DeBank Cloud 的定价：
- **1,000,000 units = $200 USD**
- **1 unit = $0.0002 USD**

### 单个 API 调用的 Units 消耗（估算）

根据 DeBank API 的常规定价模型（需要向 DeBank 确认具体数值）：

| API 接口                      | 估算 Units/次 | 说明              |
|-----------------------------|------------|-----------------|
| `used_chain_list`           | 1 unit     | 简单查询，返回链列表      |
| `all_token_list`            | 3-5 units  | 中等复杂度，需要查询多链代币  |
| `all_complex_protocol_list` | 5-10 units | 高复杂度，需要计算DeFi持仓 |

**保守估算（采用上限值）**：
- `used_chain_list`: **1 unit**
- `all_token_list`: **5 units**
- `all_complex_protocol_list`: **10 units**
- **每次刷新一个地址总计**: **16 units**

## 自动刷新配置

根据 `config.yaml`：
```yaml
sync:
  enabled: true      # 启用自动同步
  interval: 300      # 同步间隔：300秒（5分钟）
  batch_size: 10     # 每批处理10个地址
```

### 刷新频率

- **同步间隔**: 5 分钟（300秒）
- **同步策略**: 只同步 `last_synced_at` 超过5分钟的地址
- **结果**: 每个地址大约每 5-10 分钟刷新一次（取决于地址数量和批处理速度）

## 月度消耗计算

### 场景：100个地址

#### 假设条件
- 地址数量: **100个**
- 每个地址每次刷新: **16 units**
- 平均刷新间隔: **每6分钟刷新一次**（考虑批处理延迟）

#### 计算步骤

**1. 每小时刷新次数**
```
每小时刷新次数 = 60分钟 ÷ 6分钟 = 10次/小时
```

**2. 每天刷新次数**
```
每天刷新次数 = 10次/小时 × 24小时 = 240次/天
```

**3. 每月刷新次数（按30天计算）**
```
每月刷新次数 = 240次/天 × 30天 = 7,200次/月
```

**4. 每个地址每月消耗 Units**
```
单地址月度消耗 = 7,200次 × 16 units = 115,200 units/月
```

**5. 100个地址每月总消耗**
```
总月度消耗 = 115,200 units × 100地址 = 11,520,000 units/月
```

**6. 月度费用**
```
月度费用 = 11,520,000 units ÷ 1,000,000 × $200 = $2,304/月
```

## 消耗总结表

| 项目                    | 数值                   |
|-----------------------|----------------------|
| 地址数量                  | 100                  |
| 每地址每次刷新 Units         | 16 units             |
| 每地址每小时刷新次数            | 10 次                 |
| 每地址每天刷新次数             | 240 次                |
| 每地址每月刷新次数             | 7,200 次              |
| **每地址月度 Units 消耗**    | **115,200 units**    |
| **100地址月度总 Units 消耗** | **11,520,000 units** |
| **月度费用 (USD)**        | **$2,304**           |

## 优化建议

### 1. 调整刷新间隔

降低刷新频率可以显著减少 API 消耗：

| 刷新间隔     | 月度消耗 Units | 月度费用   |
|----------|------------|--------|
| 5分钟 (当前) | 11,520,000 | $2,304 |
| 10分钟     | 5,760,000  | $1,152 |
| 15分钟     | 3,840,000  | $768   |
| 30分钟     | 1,920,000  | $384   |
| 1小时      | 960,000    | $192   |


### 2. 按地址类型差异化刷新

- **活跃地址**（频繁交易）：保持5分钟刷新
- **普通地址**（偶尔交易）：改为15-30分钟刷新
- **冷钱包地址**（很少交易）：改为1-6小时刷新

### 3. 仅在有变化时刷新

实现逻辑：
- 首先调用轻量级 API（如 `total_balance`）检查总资产是否变化
- 只有当资产值变化超过阈值时，才调用完整的 token 和 protocol API

### 4. 缓存优化

- 对于不常变化的数据（如链信息），实现本地缓存
- 减少重复的 `used_chain_list` API 调用

## 重要说明

### ⚠️ 数据准确性声明

1. **Units 消耗估算**:
   - 本文档中的 units 消耗（1, 5, 10）是**保守估算**
   - 实际消耗需要参考 DeBank 官方文档或联系 DeBank 销售确认
   - 可以通过 `/v1/account/units` API 监控实际消耗

2. **定价信息**:
   - 1M units = $200 USD 是基于公开信息
   - DeBank 可能提供企业折扣或批量购买优惠
   - 建议联系 DeBank 获取准确报价

3. **刷新频率**:
   - 实际刷新频率可能因系统负载、批处理速度等因素有所不同
   - 本计算基于理想情况下的平均值

### 📊 监控实际消耗

使用 DeBank Units API 实时监控：
```bash
curl -X GET "https://pro-openapi.debank.com/v1/account/units" \
  -H "AccessKey: YOUR_API_KEY"
```

返回示例：
```json
{
  "balance": 1000000,
  "stats": [
    {
      "date": "2025-11-10",
      "usage": 115200,
      "remains": 884800
    }
  ]
}
```

### 💡 建议行动

1. **短期**: 运行1-2天，监控实际 units 消耗
2. **中期**: 根据实际消耗调整刷新策略
3. **长期**: 考虑实施差异化刷新和缓存优化

## 联系方式

如需获取准确的 API units 消耗信息：
- DeBank Cloud 文档: https://docs.cloud.debank.com
- DeBank Cloud 控制台: https://cloud.debank.com
- 联系 DeBank 销售获取企业定价

---

**文档更新日期**: 2025-11-10
**适用版本**: Rotki Demo v1.0
